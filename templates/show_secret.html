<!DOCTYPE html>
<html>
<head>
  <title>Secret Key</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 80px; }
    code {
      font-size: 24px;
      background: #eee;
      padding: 10px 20px;
      border-radius: 8px;
      display: inline-block;
    }
    button {
      margin-top: 20px;
      font-size: 18px;
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .debug-info {
      margin-top: 20px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 5px;
      font-family: monospace;
      font-size: 12px;
      text-align: left;
      max-width: 800px;
      margin: 20px auto;
      display: none;
      max-height: 400px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h2>üîê Secure Key for MAC: {{ mac }}</h2>
  <p>‚è±Ô∏è Time left: <strong id="countdown">5:00</strong></p>

  <code id="secretKey">Verifying signature...</code><br>
  <button id="useBtn" onclick="useKey()" disabled>Use this key</button>
  <button onclick="toggleDebug()">Show Debug Info</button>

  <div id="debugInfo" class="debug-info">
    <h4>Debug Information:</h4>
    <div id="debugContent"></div>
  </div>

  <!-- Load the verification logic -->
  <script src="/static/verifySignature.js"></script>
  <script>
    // Get data from Flask template - properly handle JSON
    let payload;
    let signature;
    
    try {
      // Parse the JSON payload from Flask
      const payloadJson = {{ payload_json | safe }};  // Already a JSON string from Flask
      payload = payloadJson;  // This should be an object now
      signature = "{{ signature }}";
      
      console.log('‚úÖ Data loaded from template:');
      console.log('  Payload:', payload);
      console.log('  Signature:', signature);
      
    } catch (e) {
      console.error('‚ùå Error parsing template data:', e);
      console.log('  Raw payload data:', `{{ payload_json | safe }}`);
    }

    const useBtn = document.getElementById("useBtn");
    const countdownEl = document.getElementById("countdown");
    const secretKeyEl = document.getElementById("secretKey");
    const debugContent = document.getElementById("debugContent");

    let remaining = 300;

    function updateDebugInfo() {
      const currentTime = Math.floor(Date.now() / 1000);
      debugContent.innerHTML = `
        <strong>Payload Object:</strong><br>
        ${JSON.stringify(payload, null, 2)}<br><br>
        
        <strong>Canonical Payload:</strong><br>
        ${payload ? JSON.stringify(payload, Object.keys(payload).sort()) : 'N/A'}<br><br>
        
        <strong>Signature (Base64):</strong><br>
        ${signature}<br><br>
        
        <strong>Timing:</strong><br>
        Current timestamp: ${currentTime}<br>
        Payload timestamp: ${payload ? payload.timestamp : 'N/A'}<br>
        Time difference: ${payload ? Math.abs(currentTime - payload.timestamp) : 'N/A'} seconds<br><br>
        
        <strong>Verification Steps:</strong><br>
        1. Load public key from /static/public_key.pem<br>
        2. Canonicalize payload JSON (sorted keys)<br>
        3. Verify RSA-PSS signature with SHA-256 and salt length 32<br><br>
        
        <strong>Check Console:</strong><br>
        Open browser console (F12) for detailed verification logs
      `;
    }

    function toggleDebug() {
      const debugInfo = document.getElementById('debugInfo');
      if (debugInfo.style.display === 'none' || debugInfo.style.display === '') {
        debugInfo.style.display = 'block';
        updateDebugInfo();
      } else {
        debugInfo.style.display = 'none';
      }
    }

    function updateCountdown() {
      const min = Math.floor(remaining / 60);
      const sec = remaining % 60;
      countdownEl.innerText = `${min}:${sec < 10 ? "0" + sec : sec}`;
      if (remaining <= 0) {
        countdownEl.innerText = "Expired";
        secretKeyEl.innerText = "‚õî Secret key expired";
        useBtn.disabled = true;
        return;
      }
      remaining--;
      setTimeout(updateCountdown, 1000);
    }

    // Test if verification system is working
    async function testSystem() {
      console.log('üß™ Testing verification system...');
      
      // Test if verifyQRSignature function exists
      if (typeof verifyQRSignature !== 'function') {
        console.error('‚ùå verifyQRSignature function not found - verifySignature.js may not be loaded');
        return false;
      }
      
      // Test if we can load the public key
      if (typeof testVerification === 'function') {
        return await testVerification();
      }
      
      return true;
    }

    async function verify() {
      try {
        console.log('üîç Starting verification process...');
        console.log('üìã Payload to verify:', payload);
        console.log('üìã Signature to verify:', signature);
        
        updateDebugInfo();
        
        // Validate we have the required data
        if (!payload) {
          console.error('‚ùå No payload data');
          secretKeyEl.innerText = "No payload data";
          return;
        }
        
        if (!signature) {
          console.error('‚ùå No signature data');
          secretKeyEl.innerText = "No signature data";
          return;
        }
        
        // Test if the verification system is working
        const systemOk = await testSystem();
        if (!systemOk) {
          console.error("‚ùå Verification system not working properly");
          secretKeyEl.innerText = "System error - check console";
          return;
        }
        
        // Perform verification
        const valid = await verifyQRSignature(payload, signature);
        
        if (valid) {
          console.log("‚úÖ Signature verified successfully!");
          secretKeyEl.innerText = payload.secret;
          useBtn.disabled = false;
          sessionStorage.setItem("secretKey", payload.secret);
          sessionStorage.setItem("mac", payload.mac);
        } else {
          console.error("‚õî Signature verification failed");
          secretKeyEl.innerText = "Invalid signature";
          useBtn.disabled = true;
          console.log("üí° Enable 'Show Debug Info' and check the browser console for details.");
        }
      } catch (err) {
        console.error("‚õî Signature verification error:", err);
        secretKeyEl.innerText = "Verification error";
        console.log("üí° Error details:", err.message);
      }
    }

    function useKey() {
      if (!useBtn.disabled) {
        window.location.href = "/";
      }
    }

    // Initialize
    updateCountdown();
    
    // Start verification after a short delay to ensure everything is loaded
    setTimeout(() => {
      verify();
    }, 500);
  </script>
</body>
</html>