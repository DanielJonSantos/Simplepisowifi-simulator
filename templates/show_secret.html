<!DOCTYPE html>
<html>
<head>
  <title>Secret Key</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 80px; }
    code {
      font-size: 24px;
      background: #eee;
      padding: 10px 20px;
      border-radius: 8px;
      display: inline-block;
    }
    button {
      margin-top: 20px;
      font-size: 18px;
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h2>üîê Secure Key for MAC: {{ mac }}</h2>
  <p>‚è±Ô∏è Time left: <strong id="countdown">5:00</strong></p>

  <code id="secretKey">Verifying signature...</code><br>
  <button id="useBtn" onclick="useKey()" disabled>Use this key</button>

  <!-- Payload embedded as JSON -->
<script id="payloadData" type="application/json">
  {{ payload_json | tojson | safe }}
</script>


  <!-- Inject Flask-signed base64 signature -->
  <script>
    const payload = JSON.parse(document.getElementById("payloadData").textContent);
    const signature = "{{ signature }}";
  </script>

  <!-- Verification logic -->
  <script src="/static/verifySignature.js"></script>
  <script>
    const useBtn = document.getElementById("useBtn");
    const countdownEl = document.getElementById("countdown");
    const secretKeyEl = document.getElementById("secretKey");

    let remaining = 300;
    function updateCountdown() {
      const min = Math.floor(remaining / 60);
      const sec = remaining % 60;
      countdownEl.innerText = `${min}:${sec < 10 ? "0" + sec : sec}`;
      if (remaining <= 0) {
        countdownEl.innerText = "Expired";
        secretKeyEl.innerText = "‚õî Secret key expired";
        useBtn.disabled = true;
        return;
      }
      remaining--;
      setTimeout(updateCountdown, 1000);
    }

    async function verify() {
      try {
        const valid = await verifyQRSignature(payload, signature);
        if (valid) {
          console.log("‚úÖ Signature verified.");
          secretKeyEl.innerText = payload.secret;
          useBtn.disabled = false;
          sessionStorage.setItem("secretKey", payload.secret);
          sessionStorage.setItem("mac", payload.mac);
        } else {
          console.error("‚õî Invalid server signature.");
          secretKeyEl.innerText = "Invalid signature";
          useBtn.disabled = true;
          alert("Invalid signature. Do not trust this QR.");
        }
      } catch (err) {
        console.error("‚õî Signature verification failed:", err);
        alert("Something went wrong during verification.");
      }
    }

    function useKey() {
      if (!useBtn.disabled) {
        window.location.href = "/";
      }
    }

    updateCountdown();
    verify();
  </script>
</body>
</html>
